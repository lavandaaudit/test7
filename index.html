<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<title>IBONARIUM · CHESS</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
html, body {
  margin:0; padding:0; overflow:hidden; background:#000; font-family: monospace;
}
canvas { display:block; }
#ui { position:absolute; top:12px; left:50%; transform:translateX(-50%); color:#cfefff; z-index:1; text-align:center; }
button { margin-top:6px; background:transparent; border:1px solid #2b425e; color:#cfefff; padding:6px 12px; cursor:pointer; }
button:hover { background:#0d1b2a; }
</style>
</head>
<body>
<div id="ui">
  <h1>IBONARIUM · CHESS · HARD</h1>
  <button onclick="resetGame()">Нова партія</button>
</div>
<canvas id="canvas"></canvas>

<script src="https://cdn.jsdelivr.net/npm/chess.js@1.0.0/chess.min.js"></script>
<script>
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
let w,h;
function resize(){ w=canvas.width=window.innerWidth; h=canvas.height=window.innerHeight; }
window.addEventListener("resize",resize);
resize();

/* ========= STAR FIELD ========= */
const stars = [];
for(let i=0;i<200;i++){
  stars.push({x:Math.random()*w, y:Math.random()*h, z:Math.random()*2+0.5, r:Math.random()*1.5});
}
function drawStars(){
  ctx.clearRect(0,0,w,h);
  stars.forEach(s=>{
    s.y+=0.05*s.z; if(s.y>h) s.y=0;
    ctx.globalAlpha=0.4+s.z*0.3;
    ctx.fillStyle="#fff";
    ctx.beginPath(); ctx.arc(s.x,s.y,s.r,0,Math.PI*2); ctx.fill();
  });
}

/* ========= CHESS ========= */
const boardSize = Math.min(w,h)*0.6;
const square = boardSize/8;
const boardX = (w-boardSize)/2;
const boardY = (h-boardSize)/2;

const game = new Chess();
const piecesUnicode = {
  'p':'♟','r':'♜','n':'♞','b':'♝','q':'♛','k':'♚',
  'P':'♙','R':'♖','N':'♘','B':'♗','Q':'♕','K':'♔'
};
let selected = null;

function drawBoard(){
  for(let i=0;i<8;i++){
    for(let j=0;j<8;j++){
      ctx.fillStyle = (i+j)%2===0?'#e6edf3':'#0d1117';
      ctx.fillRect(boardX+j*square, boardY+i*square, square, square);
    }
  }
}

function drawPieces(){
  ctx.font = square*0.8+"px monospace";
  ctx.textAlign="center"; ctx.textBaseline="middle";
  for(let i=0;i<8;i++){
    for(let j=0;j<8;j++){
      const piece = game.get(String.fromCharCode(97+j)+(8-i));
      if(piece){
        ctx.fillStyle = piece.color==='w'?'#dbeafe':'#1f2937';
        ctx.fillText(piecesUnicode[piece.type.toUpperCase()===piece.type?piece.type:piece.type.toLowerCase()], boardX+j*square+square/2, boardY+i*square+square/2);
      }
    }
  }
}

function getSquare(x,y){
  const file = Math.floor((x-boardX)/square);
  const rank = 8-Math.floor((y-boardY)/square);
  if(file<0||file>7||rank<1||rank>8) return null;
  return String.fromCharCode(97+file)+rank;
}

/* ========= MOUSE EVENTS ========= */
canvas.addEventListener("mousedown", e=>{
  const sq = getSquare(e.clientX,e.clientY);
  if(sq){ selected=sq; }
});
canvas.addEventListener("mouseup", e=>{
  if(!selected) return;
  const target = getSquare(e.clientX,e.clientY);
  if(target){
    const move = game.move({from:selected,to:target,promotion:'q'});
    if(move){
      selected=null;
      aiMove();
    } else selected=null;
  }
});

/* ========= STOCKFISH ========= */
const engine = new Worker("https://cdn.jsdelivr.net/npm/stockfish/stockfish.js");
engine.postMessage("uci");
engine.postMessage("setoption name Skill Level value 20");

function aiMove(){
  engine.postMessage("position fen "+game.fen());
  engine.postMessage("go depth 18");
}

engine.onmessage = e=>{
  if(e.data.startsWith("bestmove")){
    const m=e.data.split(" ")[1];
    game.move({from:m.slice(0,2), to:m.slice(2,4), promotion:'q'});
  }
};

/* ========= RESET ========= */
function resetGame(){ game.reset(); }

/* ========= ANIMATION LOOP ========= */
function animate(){
  drawStars();
  drawBoard();
  drawPieces();
  requestAnimationFrame(animate);
}
animate();
</script>
</body>
</html>
